# M15.1 Implementation Plan: Issue Infrastructure & Foundation (v0.24.0-alpha.1)

## Overview
Implement complete M15.1 infrastructure with test-first approach, including all ~50 tasks: types, resolvers, config, API functions, validators, and enhanced features (email lookup, cycle aliases, error handling).

## Implementation Approach: Sequential by Component (Option 1)

Build infrastructure layer-by-layer, completing all tests for each component before implementation.

### Rationale
1. **Clean dependencies**: Types → Resolvers → APIs is the natural order
2. **Test-first friendly**: Each component has clear test boundaries
3. **Validation points**: Can verify each layer before proceeding
4. **Single developer optimal**: Best for focused, sequential work
5. **Matches existing patterns**: Similar to how project commands evolved
6. **Lower risk**: Less chance of integration issues

---

## Phase 1: Type Definitions (2 hours)

### Tasks
- [M15.1-T01] Add `IssueCreateInput` interface to types.ts with all creation fields
- [M15.1-T02] Add `IssueUpdateInput` interface to types.ts with all update fields
- [M15.1-T03] Add `IssueListFilters` interface to types.ts with all filter options
- [M15.1-T04] Add `IssueViewData` interface to types.ts for display

### Tests First
- [M15.1-TS01] Create `tests/scripts/test-issue-infrastructure.sh`
- [M15.1-TS01] Verify TypeScript compilation with new types (npm run typecheck)

### Implementation Steps
1. Create test script skeleton: `tests/scripts/test-issue-infrastructure.sh`
2. Add test cases for type compilation
3. Add to `src/lib/types.ts`:
   - `IssueCreateInput` interface (23+ fields):
     - title, teamId, description, descriptionData
     - priority, estimate, stateId
     - assigneeId, subscriberIds
     - projectId, cycleId, parentId
     - labelIds, dueDate, templateId
   - `IssueUpdateInput` interface (33+ fields):
     - All create fields plus trash, remove variants
   - `IssueListFilters` interface (20+ filter options):
     - team, assignee, project, initiative
     - state, priority, labels, search
     - parent, cycle, status filters
   - `IssueViewData` interface (display fields)
4. Run `npm run typecheck` to verify

### Deliverable
- 4 new interfaces in types.ts
- typecheck passes with no errors
- Test script created

---

## Phase 2: Issue Resolver (3 hours)

### Tasks
- [M15.1-T05] Create src/lib/issue-resolver.ts with `resolveIssueIdentifier()` function
- [M15.1-T06] Implement UUID format detection and passthrough
- [M15.1-T07] Implement team-key + number parsing (ENG-123 format)
- [M15.1-T07a] Add identifier format validation (regex for team-number pattern)
- [M15.1-T08] Implement GraphQL query to resolve identifier to UUID
- [M15.1-T08a] Add UUID format validation (proper UUID structure check)
- [M15.1-T09] Add caching for resolved identifiers (optional optimization)

### Tests First
- [M15.1-TS02] Test resolver with ENG-123 format identifiers
- [M15.1-TS03] Test resolver with UUID format
- [M15.1-TS04] Test resolver with invalid identifiers (error handling)
- [M15.1-TS04a] Test error: malformed identifier (e.g., "ENG", "123", "invalid-123")
- [M15.1-TS04b] Test error: identifier with invalid characters (e.g., "ENG-123abc")
- [M15.1-TS04c] Test case insensitivity (eng-123 vs ENG-123 should both work)

### Implementation Steps
1. Add test cases to `test-issue-infrastructure.sh` for resolver
2. Create `src/lib/issue-resolver.ts` following project-resolver.ts pattern:
   ```typescript
   interface ResolveResult {
     issueId: string;
     issue?: any;
     resolvedBy: 'id' | 'identifier';
   }

   export async function resolveIssueIdentifier(input: string): Promise<ResolveResult | null>
   export async function resolveIssueId(input: string): Promise<string | null>
   ```
3. Implement UUID detection: `/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i`
4. Implement identifier parsing: `/^[A-Z]+-\d+$/i` (case insensitive)
5. Add GraphQL query for identifier lookup
6. Add optional caching with Map/entity-cache
7. Run tests to verify all cases

### Deliverable
- Working issue resolver
- All resolver tests pass (TS02-TS04c)
- Handles UUID, ENG-123, and invalid inputs correctly

---

## Phase 3: Config System (1.5 hours)

### Tasks
- [M15.1-T10] Add `defaultProject` support to config.ts
- [M15.1-T10a] Verify defaultTeam config key exists in config.ts
- [M15.1-T11] Update config get/set/list commands to handle defaultProject and defaultTeam

### Tests First
- [M15.1-TS05] Test config set/get for defaultProject
- [M15.1-TS05a] Test config set/get for defaultTeam

### Implementation Steps
1. Add test cases to `test-issue-infrastructure.sh` for config
2. Update `src/lib/config.ts`:
   - Add defaultProject to ConfigData interface (if not exists)
   - Update getConfig() to include defaultProject
   - Update setConfigValue() to handle 'defaultProject'
   - Add validation helper for team/project compatibility
3. Verify defaultTeam already exists (should be there)
4. Update config commands if needed (likely already work)
5. Run tests to verify set/get works

### Deliverable
- defaultProject config support implemented
- Config commands handle new field
- Tests pass (TS05-TS05a)

---

## Phase 4: Enhanced Resolvers (4 hours)

### Tasks

#### Member Resolution
- [M15.1-T19] Implement email lookup in member resolver
- [M15.1-T20] Implement display name lookup fallback in member resolver
- [M15.1-T20a] Add disambiguation logic for multiple name matches
- [M15.1-TS10] Test member resolution by email
- [M15.1-TS11] Test member resolution by display name
- [M15.1-TS11a] Test error: multiple users match display name

#### Project Name Resolution
- [M15.1-T21] Implement project name resolver
- [M15.1-T21a] Add exact name matching for project resolution
- [M15.1-T21b] Add fuzzy/partial name matching with disambiguation
- [M15.1-TS12] Test project resolution by exact name
- [M15.1-TS13] Test project resolution by partial name match
- [M15.1-TS14] Test error: ambiguous project name

#### Cycle Alias Support
- [M15.1-T22] Add 'cycle' to supported alias types in aliases.ts
- [M15.1-T22a] Implement cycle resolver supporting both UUID and alias
- [M15.1-TS14a] Test cycle resolution by UUID
- [M15.1-TS14b] Test cycle resolution by alias

### Tests First
1. Add test cases for member email lookup
2. Add test cases for member display name with disambiguation
3. Add test cases for project name resolution
4. Add test cases for cycle aliases

### Implementation Steps

**Member Resolution:**
1. Add to `src/lib/linear-client.ts` or create `src/lib/member-resolver.ts`:
   ```typescript
   async function resolveMemberByEmail(email: string): Promise<string | null>
   async function resolveMemberByDisplayName(name: string): Promise<string | null>
   ```
2. Implement email lookup via Linear API users query
3. Implement display name lookup with disambiguation
4. Update existing member resolution to use these

**Project Resolution:**
1. Enhance `src/lib/project-resolver.ts`:
   - Add exact name matching (case-insensitive)
   - Add fuzzy/partial matching
   - Add disambiguation error for multiple matches

**Cycle Aliases:**
1. Update `src/lib/types.ts`: Add 'cycle' to AliasEntityType
2. Update `src/lib/aliases.ts`: Handle cycle alias CRUD
3. Create cycle resolver supporting UUID and alias

### Deliverable
- Enhanced member resolution (email, display name)
- Project name resolution with fuzzy matching
- Cycle alias support
- All tests pass (TS10-TS14b)

---

## Phase 5: Linear Client Functions (3 hours)

### Tasks
- [M15.1-T12] Add `createIssue(input: IssueCreateInput)` to linear-client.ts
- [M15.1-T13] Add `updateIssue(id: string, input: IssueUpdateInput)` to linear-client.ts
- [M15.1-T14] Add `getIssueById(id: string)` to linear-client.ts
- [M15.1-T15] Add `getIssueByIdentifier(identifier: string)` to linear-client.ts
- [M15.1-T16] Add `getAllIssues(filters: IssueListFilters)` to linear-client.ts
- [M15.1-T17] Add `getCurrentUserIssues()` helper for list defaults

### Tests First
- [M15.1-TS06] Test createIssue API function with minimal input
- [M15.1-TS07] Test getIssueById API function
- [M15.1-TS08] Test getAllIssues API function with basic filters

### Implementation Steps
1. Add test cases for API functions (create test issue, fetch it, list it)
2. Add to `src/lib/linear-client.ts`:

   **createIssue:**
   ```typescript
   export async function createIssue(input: IssueCreateInput): Promise<Issue> {
     const client = getLinearClient();
     const issue = await client.createIssue({
       title: input.title,
       teamId: input.teamId,
       // ... map all fields
     });
     return issue;
   }
   ```

   **updateIssue:**
   ```typescript
   export async function updateIssue(id: string, input: IssueUpdateInput): Promise<Issue> {
     const client = getLinearClient();
     const issue = await client.updateIssue(id, {
       // ... map all fields
     });
     return issue;
   }
   ```

   **getIssueById:**
   ```typescript
   export async function getIssueById(id: string): Promise<Issue | null> {
     const client = getLinearClient();
     const issue = await client.issue(id);
     return issue || null;
   }
   ```

   **getIssueByIdentifier:**
   ```typescript
   export async function getIssueByIdentifier(identifier: string): Promise<Issue | null> {
     const client = getLinearClient();
     const issues = await client.issues({
       filter: { identifier: { eq: identifier.toUpperCase() } }
     });
     return issues.nodes[0] || null;
   }
   ```

   **getAllIssues (efficient, single-query):**
   ```typescript
   export async function getAllIssues(filters?: IssueListFilters): Promise<Issue[]> {
     const client = getLinearClient();
     // Build GraphQL filter from filters object
     const graphqlFilter = buildIssueFilter(filters);
     const issues = await client.issues({ filter: graphqlFilter });
     return issues.nodes;
   }
   ```

   **getCurrentUserIssues:**
   ```typescript
   export async function getCurrentUserIssues(): Promise<Issue[]> {
     const client = getLinearClient();
     const user = await client.viewer;
     return getAllIssues({ assigneeId: user.id });
   }
   ```

3. Ensure efficient queries (no N+1 patterns)
4. Run integration tests with real API

### Deliverable
- 6 new API functions in linear-client.ts
- All API tests pass (TS06-TS08)
- Functions use efficient single-query patterns

---

## Phase 6: Validators & Error Handling (2.5 hours)

### Tasks

#### Validators
- [M15.1-T18] Add issue-specific validators to src/lib/validators.ts
- [M15.1-TS09] Test validators with valid and invalid inputs

#### GraphQL Error Handling
- [M15.1-T23] Implement GraphQL error handler in src/lib/error-handler.ts
- [M15.1-T24] Add user-friendly error messages for common Linear errors
- [M15.1-TS15] Test error: API returns 401 (authentication failed)
- [M15.1-TS16] Test error: API returns 403 (permission denied)
- [M15.1-TS17] Test error: API returns 429 (rate limited)
- [M15.1-TS18] Test error: API returns 404 (not found)

#### Alias Resolution Error Messages
- [M15.1-T25] Add helpful alias resolution error messages
- [M15.1-TS19] Test error: alias doesn't exist
- [M15.1-TS20] Test error: typo in alias name (with "did you mean" suggestion)

### Tests First
1. Add validator test cases
2. Add error handling test cases (mock or trigger real errors)
3. Add alias error test cases

### Implementation Steps

**Validators:**
1. Update `src/lib/validators.ts`:
   - Verify priority validator exists and works for issues
   - Add any issue-specific validators needed
   - Follow existing ValidationResult pattern

**Error Handler:**
1. Create `src/lib/error-handler.ts`:
   ```typescript
   export function handleLinearError(error: any): string {
     // Parse error.response or error.message
     if (error.status === 401) {
       return "Authentication failed. Check LINEAR_API_KEY environment variable.";
     }
     if (error.status === 403) {
       return "Permission denied. You don't have access to this resource.";
     }
     if (error.status === 404) {
       return "Resource not found. Check that ID/identifier is correct.";
     }
     if (error.status === 429) {
       return "Rate limited. Please wait and try again.";
     }
     // Extract Linear validation errors
     return error.message || "An unexpected error occurred.";
   }
   ```

**Alias Error Messages:**
1. Update `src/lib/aliases.ts`:
   - Enhance error messages to show available aliases
   - Add fuzzy matching for suggestions:
   ```typescript
   function findSimilarAliases(input: string, aliases: string[]): string[] {
     // Simple Levenshtein or substring matching
     return aliases.filter(a =>
       a.toLowerCase().includes(input.toLowerCase()) ||
       levenshteinDistance(a, input) <= 2
     );
   }
   ```

### Deliverable
- Issue validators added
- Error handler with user-friendly messages
- Enhanced alias errors with suggestions
- All tests pass (TS09, TS15-TS20)

---

## Testing Strategy

### Test Script: `tests/scripts/test-issue-infrastructure.sh`

```bash
#!/bin/bash
# M15.1 Infrastructure Tests (~20 test cases)

set -e

echo "=========================================="
echo "M15.1 Infrastructure Tests"
echo "=========================================="

TIMESTAMP=$(date +%s)
TEST_PREFIX="TEST_INFRA_${TIMESTAMP}_"

# Test 1: Type compilation
echo "Test 1: Verify TypeScript compilation"
npm run typecheck

# Test 2-7: Issue resolver tests
echo "Test 2: Resolve issue by UUID"
# Create test issue, resolve by UUID

echo "Test 3: Resolve issue by identifier (ENG-123)"
# Resolve by team-number format

echo "Test 4: Test case insensitivity (eng-123)"
# Verify lowercase works

echo "Test 5: Test invalid identifier format"
# Should fail gracefully

# Test 8-9: Config tests
echo "Test 8: Set defaultProject config"
linear-create config set defaultProject "test-project-id"

echo "Test 9: Get defaultProject config"
# Verify retrieval

# Test 10-14: Enhanced resolver tests
echo "Test 10: Resolve member by email"
echo "Test 11: Resolve member by display name"
echo "Test 12: Project resolution by name"
echo "Test 13: Cycle alias resolution"

# Test 15-17: API function tests
echo "Test 15: Create issue with API"
# Create minimal test issue

echo "Test 16: Get issue by ID"
# Fetch created issue

echo "Test 17: List issues with filters"
# List and verify

# Test 18-20: Error handling tests
echo "Test 18: Test invalid API key (401)"
echo "Test 19: Test alias not found error"
echo "Test 20: Test did you mean suggestion"

echo ""
echo "=========================================="
echo "✅ All M15.1 infrastructure tests passed!"
echo "=========================================="

# Generate cleanup script
cat > cleanup-infrastructure-test.sh <<EOF
#!/bin/bash
# Cleanup script for M15.1 infrastructure tests
echo "Test issues created: ${TEST_PREFIX}*"
echo "Please delete manually via Linear UI"
EOF

chmod +x cleanup-infrastructure-test.sh
```

---

## Verification Checklist

### After Each Phase
- [ ] `npm run build` succeeds
- [ ] `npm run typecheck` passes
- [ ] `npm run lint` passes (no new errors)
- [ ] Relevant tests pass
- [ ] Update MILESTONES.md (mark tasks as [x] completed)

### Final M15.1 Verification
- [ ] All infrastructure tests pass (~20 test cases)
- [ ] Issue resolver works (ENG-123 and UUID)
- [ ] Member resolver supports ID, alias, email, display name
- [ ] Project resolver supports ID, alias, name
- [ ] Cycle resolver supports UUID and alias
- [ ] Config defaultProject can be set/retrieved
- [ ] Error messages are helpful for all failure modes
- [ ] Linear API functions execute without runtime errors
- [ ] No N+1 query patterns detected
- [ ] `npm run build` succeeds
- [ ] `npm run typecheck` passes
- [ ] `npm run lint` passes

---

## Release Process (M15.1 Complete)

1. **Final verification** - All tests pass, build succeeds
2. **Update MILESTONES.md** - Mark all M15.1 tasks as [x]
3. **Update version** - package.json and src/cli.ts to v0.24.0-alpha.1
4. **Commit**: `git commit -m "feat: M15.1 - Issue infrastructure and foundation (v0.24.0-alpha.1)"`
5. **Tag**: `git tag v0.24.0-alpha.1`
6. **Push**: `git push && git push --tags`

---

## Time Estimates

| Phase | Description | Estimated Time |
|-------|-------------|----------------|
| 1 | Type Definitions | 2 hours |
| 2 | Issue Resolver | 3 hours |
| 3 | Config System | 1.5 hours |
| 4 | Enhanced Resolvers | 4 hours |
| 5 | Linear Client Functions | 3 hours |
| 6 | Validators & Error Handling | 2.5 hours |
| **Total** | | **16 hours** |

---

## Success Criteria

✅ All 50+ M15.1 tasks completed
✅ ~20 infrastructure test cases pass
✅ Build, typecheck, lint all pass
✅ Issue resolution works for all formats
✅ Enhanced member/project resolution works
✅ Cycle aliases supported
✅ Config system supports defaultProject
✅ Error handling is user-friendly
✅ No performance issues (N+1 patterns)
✅ MILESTONES.md updated
✅ v0.24.0-alpha.1 tagged and released

---

## Next Steps

After M15.1 completion:
- **M15.2** (v0.24.0-alpha.2): Issue View Command
- **M15.3** (v0.24.0-alpha.3): Issue Create Command
- **M15.4** (v0.24.0-alpha.4): Issue Update Command
- **M15.5** (v0.24.0-alpha.5): Issue List Command
- **M15.6** (v0.24.0): Interactive Enhancements + Final Release
